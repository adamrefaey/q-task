name: Update Python version badge

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  python-version-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Generate Python version badge
        uses: emibcn/badge-action@v2.0.2
        with:
          label: "Python"
          status: "3.11 | 3.12 | 3.13 | 3.14"
          color: "3776ab"
          icon: "python"
          path: ".github/python-version.svg"

      - name: Commit Python version badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME || github.actor }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL || format('%s@users.noreply.github.com', github.actor) }}
        run: |
          set -euo pipefail
          if [ -z "${PERSONAL_ACCESS_TOKEN:-}" ]; then
            echo "PERSONAL_ACCESS_TOKEN is not set. Skipping push to remote to avoid protected branch rejection."
            exit 0
          fi
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"
          remote_url=$(git remote get-url origin)
          if [[ "$remote_url" == https://* ]]; then
            auth_remote=$(echo "$remote_url" | sed -E "s#https://#https://${PERSONAL_ACCESS_TOKEN}@#")
            git remote set-url origin "$auth_remote"
          fi
          git add .github/python-version.svg || true
          if ! git diff --staged --quiet; then
            if [ -n "${GPG_PRIVATE_KEY:-}" ]; then
              echo "$GPG_PRIVATE_KEY" | gpg --batch --import || true
              keyid=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec/ {print $5; exit}') || true
              if [ -n "$keyid" ]; then
                git config user.signingkey "$keyid" || true
                git config commit.gpgsign true || true
                export GIT_COMMITTER_SIGNINGKEY="$keyid"
              fi
            fi
            if [ -n "${GPG_PRIVATE_KEY:-}" ]; then
              git commit -S -m "chore: update Python version badge" || true
            else
              git commit -m "chore: update Python version badge" || true
            fi
            git push origin HEAD:main || true
          else
            echo "No changes to Python version badge"
          fi
